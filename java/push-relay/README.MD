# Registration Backend - push-relay

## setup
this uses maven and embedded tomcat

can be run natively or via docker

### build and run with docker

#### build
```
sudo make docker # sudo needed if user is not in docker group
```

#### configure and run
- certificates need to be reachable via your docker service, by defaul this is `deploy/cert-stores/`
- mqtt.hostname and port must be configured, so mqtt clients can connect; see `deploy/conf/push-relay.docker.yml`

then run:
```
./deploy/run-docker.sh
```


### IDE config
this project uses lombok. You might need to enable support for it in your IDE.
see https://projectlombok.org/setup/overview

## certificate generation
we need a 3 java keystores to run the server:

- keystore.p12
- castore.p12
- truststore.p12

see `<root of this project>/tls-pinning` for some helpful scripts.

### keystore.p12
holds the server key, with which the server authenticates itself to its clients.

### castore.p12
certificate, with which all client keys generated by the CA of the server are signed.
the server must trusts this key and its signatures. (see truststore.p12 below)

This cert must be generated using openssl (since java is not capable of producing a CA cert) and then imported to the castore.p12


### truststore.p12
truststore, should contain the pubkey of the CA only.

### generation of a keystore for the server and CA
generate certificates (e.g. in the folder 'cert-stores'):
```
keytool -genkey -keyalg EC -alias server -validity 360 -storetype pkcs12 -keystore keystore.jks
```
store the password and keystore location in application properties under
```
ssl.keyStorePassword
ssl.keyStore
```
when asked for first- and lastname, enter your domain CN e.g. your hostname

to verify the generated certificate, run
```
keytool -list -v -keystore keystore.p12
```

The CA pubkey needs to exported to be able to trust it.
This is needed for our server truststore.p12 and for pinning in the client app.
to export a certificate, run
```
keytool -export -alias ca -keystore castore.p12 -file server.cer
```

TODO this should be done automatically on build or solved differently

for now, do the same for `ssl.trustStore` and `ssl.trustStorePassword` (client certs are still hardcoded)

## remove other CAs
TODO document `cacerts` file; see https://docs.oracle.com/javase/1.5.0/docs/tooldocs/solaris/keytool.html#cacerts
should we remove other cacerts from the machine of the relay host?
